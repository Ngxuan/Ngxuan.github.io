<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Page</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            background-image: url("{% static 'image/quizbackground.png' %}"); /* Background image */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .quiz-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .quiz-box {
            width: 70%;
            height: 70%;
        }

        .home-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #17a2b8;
            border: none;
            border-radius: 50%;
            padding: 10px;
            cursor: pointer;
            z-index: 1000;
            transition: background 0.3s, transform 0.3s;
        }

        .home-button:hover {
            background: #138496;
            transform: scale(1.1);
        }

        .home-button img {
            width: 30px;
            height: 30px;
        }

        .quiz-question h2 {
            font-size: 40px;
            font-weight: bold;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.9); /* Light white background with transparency */
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Add shadow effect */
        }

        .quiz-options {
            margin-top: 10%;
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Create a grid with 2 columns */
            gap: 40px; /* Increase space between buttons */
        }

        .quiz-option {
            font-size: 30px; /* Increase the font size */
            padding: 70px; /* Increase the padding */
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.2s;
            color: white;
            width: 100%; /* Set the width of the buttons */
            text-align: center; /* Center the text */
        }

        .quiz-option:hover {
            transform: scale(1.1); /* Slightly increase size on hover */
        }

        /* Custom colors for each button */
        .btn-color-1 {
            background-color: #FCE098; /* Yellow */
            color: black;
            font-weight: bold;
        }

        .btn-color-2 {
            background-color: #B3E5FC; /* Light Blue */
            color: black;
            font-weight: bold;
        }

        .btn-color-3 {
            background-color: #E2BB96; /* Light Green */
            color: black;
            font-weight: bold;
        }

        .btn-color-4 {
            background-color: #F5CFF6; /* Pink */
            color: black;
            font-weight: bold;
        }

        /* Correct answer */
        .btn-correct {
            background-color: #4CAF50; /* Green */
            color: white;
        }

        /* Incorrect answer */
        .btn-incorrect {
            background-color: #F44336; /* Red */
            color: white;
        }

        /* Inactive state for options */
        .btn-inactive {
            background-color: #e0e0e0; /* Grey */
            color: black;
        }

        /* Progress bar styling */
        .progress-bar-container {
            width: 100%;
            height: 30px;
            background-color: #f3f3f3;
            border-radius: 15px;
            margin: 20px 0;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Add shadow effect */
        }

        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            width: 0%; /* Initial width is 0 */
            border-radius: 15px;
            transition: width 5s linear; /* Transition width over 5 seconds */
        }

        /* Hide all questions by default */
        .quiz-question {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Home Button -->
        <a href="{% url 'child_home' childID=childID %}" class="home-button" id="homeButton">
            <button style="background: transparent; border: none;">
                <img src="https://img.icons8.com/material-rounded/24/ffffff/home.png" alt="Home">
            </button>
        </a>

        <!-- Quiz Title -->
        <div class="text-center mb-4">
            <h1>{{ quiz.title }}</h1>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>

        <!-- Quiz Content -->
 <div class="quiz-container">
            <div class="quiz-box">
                <!-- Loop through each question -->
                {% for question_data in questions_with_correct_option %}
                <div class="quiz-question"
                     id="question-{{ forloop.counter }}"
                     data-correct-option="{{ question_data.correct_option_id }}">
                    <h2>{{ question_data.question.question }}</h2>
                    <div class="quiz-options">
                        {% for option in question_data.question.options.all %}
                        <!-- Assign a unique class to each option based on the loop counter -->
                        <button class="quiz-option btn-color-{{ forloop.counter }}"
                                id="option-{{ option.optionID }}"
                                onclick="checkAnswer('{{ question_data.question.quizQuestionID }}', '{{ option.optionID }}', {{ forloop.parentloop.counter }})">
                            {{ option.text }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
                <!-- Message shown when all questions are completed -->
                <div class="quiz-question" id="quiz-end">
                    <h2>Quiz Completed! Well done!</h2>
                    <p id="quiz-score"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // JavaScript to control quiz question flow and answer validation
        let currentQuestion = 1; // Track current question
        let correctAnswers = 0;  // Track the number of correct answers
        const totalQuestions = {{ questions_with_correct_option|length }}; // Total number of questions

        // Function to check the answer and show the next question
        function checkAnswer(questionID, selectedOptionID, current) {
            // Get the correct option ID for the current question
            const correctOptionID = document.getElementById(`question-${current}`).dataset.correctOption;

            // Get all options for the current question
            const options = document.querySelectorAll(`#question-${current} .quiz-option`);

            // Loop through options and style them based on whether they are correct or incorrect
            options.forEach(option => {
                if (option.id === `option-${correctOptionID}`) {
                    option.classList.add('btn-correct'); // Mark the correct answer in green
                } else if (option.id === `option-${selectedOptionID}`) {
                    option.classList.add('btn-incorrect'); // Mark the selected (incorrect) answer in red
                } else {
                    option.classList.add('btn-inactive'); // Mark all other options as inactive (grey)
                }
                option.disabled = true; // Disable all buttons after selecting an answer
            });

            // Check if the selected answer is correct
            if (selectedOptionID === correctOptionID) {
                correctAnswers++; // Increment the correct answer count
            }

            // Start the progress bar animation
            startProgressBar();

            // Wait for 5 seconds before showing the next question
            setTimeout(() => showNextQuestion(current), 5000);
        }

        // Function to show the next question
        function showNextQuestion(current) {
            // Hide the current question
            document.getElementById(`question-${current}`).style.display = 'none';

            // Reset the progress bar
            resetProgressBar();

            // Determine the next question to show
            const nextQuestion = current + 1;
            if (nextQuestion <= totalQuestions) {
                // Show the next question
                document.getElementById(`question-${nextQuestion}`).style.display = 'block';
            } else {
                // All questions are completed, show end message
                document.getElementById('quiz-end').style.display = 'block';

                // Calculate and display the score
                const score = Math.round((correctAnswers / totalQuestions) * 100);
                document.getElementById('quiz-score').innerText = `You got ${correctAnswers} out of ${totalQuestions} correct. Your score is ${score}%.`;

                // Save the quiz result using AJAX
                saveQuizResult(score, correctAnswers);
            }
        }

        // Function to save the quiz result using AJAX
        function saveQuizResult(score, correctAnswers) {
            const childQuizID = "{{ child_quiz.childQuizID }}"; // Use childQuiz ID from context

            fetch(`/quizzes/save_result/${childQuizID}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'  // Include CSRF token for security
                },
                body: JSON.stringify({ score: score, correct_answers: correctAnswers })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.message);
            })
            .catch(error => {
                console.error('Error saving quiz result:', error);
            });
        }

        // Functions for progress bar animation (same as before)
        function startProgressBar() {
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = '100%'; // Animate to full width over 5 seconds
        }

        function resetProgressBar() {
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = '0%'; // Reset the width to 0
        }

        // Show the first question by default
        document.getElementById('question-1').style.display = 'block';
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>